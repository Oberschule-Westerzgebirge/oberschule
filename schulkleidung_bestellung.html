<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bestellung Schulkleidung - Oberschule Westerzgebirge Bad Schlema</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .deadline {
            background: #fed7d7;
            color: #c53030;
            padding: 15px;
            text-align: center;
            font-weight: bold;
            border-bottom: 3px solid #fc8181;
        }
        
        .form-content {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 18px;
            color: #667eea;
        }
        
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-group label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #2d3748;
        }
        
        .form-group input[type="text"],
        .form-group input[type="email"],
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
            background: white;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .required {
            color: #e53e3e;
        }
        
        .products-section {
            margin-top: 30px;
        }
        
        .products-section h2 {
            color: #2d3748;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }
        
        .color-legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin: 20px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .color-box {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .color-sample {
            width: 25px;
            height: 25px;
            border-radius: 4px;
            border: 2px solid #cbd5e0;
        }
        
        .product-card {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            margin-bottom: 20px;
            background: white;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .product-card.expanded {
            border-color: #667eea;
        }
        
        .product-card:nth-child(even) {
            background: #f7fafc;
        }
        
        .product-header {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr auto;
            gap: 15px;
            padding: 20px;
            cursor: pointer;
            user-select: none;
            align-items: center;
        }
        
        .product-header:hover {
            background: rgba(102, 126, 234, 0.05);
        }
        
        .expand-icon {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #667eea;
            color: white;
            border-radius: 50%;
            font-weight: bold;
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .product-card.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .product-header-item {
            display: flex;
            flex-direction: column;
        }
        
        .product-header-item label {
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .product-header-item .value {
            font-size: 16px;
            color: #667eea;
            font-weight: bold;
        }
        
        .colors-grid {
            display: none;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 20px 20px 20px;
            border-top: 2px solid #e2e8f0;
            padding-top: 20px;
        }
        
        .product-card.expanded .colors-grid {
            display: grid;
        }
        
        .color-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
        }
        
        .product-card:nth-child(even) .color-item {
            background: #f7fafc;
        }
        
        .color-item.disabled {
            background: #f0f0f0;
            opacity: 0.5;
        }
        
        .color-label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #2d3748;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .size-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
        }
        
        .size-input-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .size-input-group label {
            font-size: 11px;
            color: #718096;
            font-weight: bold;
            text-align: center;
        }
        
        .size-input-group input[type="number"] {
            width: 100%;
            padding: 6px;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        
        .size-input-group input[type="number"]:disabled {
            background: #e2e8f0;
        }
        
        .total-section {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 8px;
            text-align: right;
        }
        
        .total-section h3 {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 10px;
        }
        
        .total-amount {
            font-size: 32px;
            color: #667eea;
            font-weight: bold;
        }
        
        /* KRITISCH: Diese Sektionen sind initial versteckt */
        .signature-section {
            display: none;
            margin-top: 20px;
            padding: 15px;
            background: #fff5e6;
            border: 2px solid #f59e0b;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .signature-section h3 {
            color: #d97706;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .signature-section .warning {
            background: #fed7d7;
            padding: 10px;
            border-left: 3px solid #fc8181;
            margin-bottom: 10px;
            border-radius: 4px;
            color: #c53030;
            font-weight: bold;
            font-size: 11px;
        }
        
        .signature-fields {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 15px;
            margin-top: 10px;
        }
        
        .signature-field {
            display: flex;
            flex-direction: column;
        }
        
        .signature-field label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2d3748;
            font-size: 11px;
        }
        
        .signature-line {
            border-bottom: 2px solid #2d3748;
            min-height: 40px;
            padding-top: 20px;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 15px 40px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #718096;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #4a5568;
        }
        
        .info-box {
            background: #bee3f8;
            border-left: 4px solid #3182ce;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .error-box {
            background: #fed7d7;
            border-left: 4px solid #fc8181;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            color: #c53030;
        }
        
        .closed-message {
            display: none;
            background: #fff5e6;
            border: 3px solid #f59e0b;
            border-radius: 8px;
            padding: 30px;
            margin: 20px 0;
            text-align: center;
        }
        
        .closed-message.show {
            display: block;
        }
        
        .closed-message h2 {
            color: #d97706;
            margin-bottom: 15px;
        }
        
        .closed-message p {
            color: #2d3748;
            font-size: 16px;
            line-height: 1.6;
        }
        
        .success-message {
            display: none;
            background: #c6f6d5;
            border-left: 4px solid #38a169;
            padding: 20px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .success-message.show {
            display: block;
        }
        
        .success-message .print-button {
            display: inline-block;
            margin-top: 15px;
            padding: 12px 30px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            border: none;
            font-size: 16px;
        }
        
        .success-message .print-button:hover {
            background: #5568d3;
        }
        
        /* KRITISCH: Print-Summary ist initial versteckt */
        .print-summary {
            display: none;
        }
        
        .print-summary h2 {
            font-size: 18px;
            margin-bottom: 10px;
            color: #2d3748;
        }
        
        .print-summary table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 12px;
        }
        
        .print-summary th,
        .print-summary td {
            border: 1px solid #2d3748;
            padding: 6px;
            text-align: left;
        }
        
        .print-summary th {
            background-color: #4a5568;
            color: white;
            font-weight: bold;
            font-size: 11px;
        }
        
        .print-summary .total-row {
            background-color: #f7fafc;
            font-weight: bold;
        }
        
        .print-summary .info-box {
            background: #f7fafc;
            padding: 8px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 11px;
            border: 1px solid #cbd5e0;
        }
        
        .print-summary .info-box p {
            margin: 2px 0;
        }
        
        /* DRUCK-STILE */
        @media print {
            body {
                background: white;
                padding: 0;
            }
            
            /* Verstecke alle nicht ben√∂tigten Elemente beim Drucken */
            .button-group,
            .deadline,
            .form-group,
            .info-box:not(.print-summary .info-box),
            .success-message,
            .products-section,
            .total-section,
            .color-legend {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
            }
            
            /* Zeige die Druckzusammenfassung */
            .print-summary {
                display: block !important;
                padding: 20px;
            }
            
            .print-summary .info-box {
                display: block !important;
            }
            
            /* Zeige die Unterschriftensektion */
            .signature-section {
                display: block !important;
                break-inside: avoid;
                page-break-inside: avoid;
            }
        }
        
        @media (max-width: 768px) {
            .container {
                max-width: 100%;
            }
            
            .product-header {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .product-header-item {
                text-align: center;
            }
            
            .colors-grid {
                grid-template-columns: 1fr;
            }
            
            .color-legend {
                font-size: 12px;
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .color-sample {
                width: 18px;
                height: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Bestellung Schulkleidung</h1>
            <p>Oberschule Westerzgebirge Bad Schlema</p>
            <p id="schuljahrDisplay">L√§dt...</p>
        </div>
        
        <div class="deadline" id="deadlineDisplay">
            ‚ö†Ô∏è L√§dt Abgabetermin...
        </div>
        
        <div class="form-content">
            <div class="loading" id="loadingMessage">
                üìÑ Lade Artikel und Sch√ºlerdaten aus der Datenbank...
            </div>
            
            <div id="errorMessage" class="error-box" style="display: none;">
                <strong>‚ö†Ô∏è Fehler beim Laden!</strong>
                <p>Bitte kontaktieren Sie das Sekretariat: oswe.schulkleidung@gmail.com</p>
            </div>
            
            <div class="closed-message" id="closedMessage">
                <h2>üîí Bestellungen derzeit geschlossen</h2>
                <p id="closedMessageText">Das Bestellformular ist aktuell nicht verf√ºgbar.</p>
                <p style="margin-top: 20px;">Bei Fragen wenden Sie sich bitte an:<br>
                <strong>oswe.schulkleidung@gmail.com</strong></p>
            </div>
            
            <div class="success-message" id="successMessage">
                <h3>‚úÖ Bestellung erfolgreich √ºbermittelt!</h3>
                <p>Die Bestellung wurde gespeichert und Sie erhalten in K√ºrze eine Best√§tigungs-E-Mail.</p>
                <button class="print-button" onclick="window.print()">üñ®Ô∏è Jetzt ausdrucken</button>
            </div>
            
            <form id="orderForm" style="display: none;">
                <div class="form-group">
                    <label>Klasse: <span class="required">*</span></label>
                    <select id="studentClass" required onchange="updateSchuelerDropdown()">
                        <option value="">Bitte w√§hlen...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Name, Vorname: <span class="required">*</span></label>
                    <select id="studentName" required>
                        <option value="">Erst Klasse w√§hlen...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>E-Mail (f√ºr Best√§tigung): <span class="required">*</span></label>
                    <input type="email" id="email" required placeholder="beispiel@email.de">
                </div>
                
                <div class="form-group">
                    <label>E-Mail wiederholen: <span class="required">*</span></label>
                    <input type="email" id="emailConfirm" required placeholder="beispiel@email.de">
                    <small id="emailMatchError" style="color: #e53e3e; display: none; margin-top: 5px;">‚ö†Ô∏è Die E-Mail-Adressen stimmen nicht √ºberein!</small>
                </div>
                
                <div class="info-box">
                    <strong>Hinweis:</strong> W√§hlen Sie bei jeder gew√ºnschten Farbe die Gr√∂√üe und Anzahl aus. Bitte beachten Sie, dass nicht jeder Artikel in jeder Farbe verf√ºgbar ist. Wir bitten um Verst√§ndnis!
                </div>
                
                <div class="products-section">
                    <h2>üì¶ Artikelauswahl</h2>
                    
                    <div class="color-legend" id="colorLegend"></div>
                    
                    <div id="productsContainer"></div>
                </div>
                
                <div class="total-section">
                    <h3>Gesamtbetrag:</h3>
                    <div class="total-amount" id="totalAmount">0,00 ‚Ç¨</div>
                </div>
                
                <div class="button-group">
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">Zur√ºcksetzen</button>
                    <button type="submit" class="btn btn-primary">Bestellung absenden</button>
                </div>
            </form>
            
            <!-- DRUCK-ZUSAMMENFASSUNG: Initial versteckt, nur beim Drucken sichtbar -->
            <div class="print-summary" id="printSummary">
                <h2>Bestellzusammenfassung</h2>
                <div class="info-box">
                    <p><strong>Name:</strong> <span id="printName"></span></p>
                    <p><strong>Klasse:</strong> <span id="printClass"></span></p>
                    <p><strong>E-Mail:</strong> <span id="printEmail"></span></p>
                    <p><strong>Bestelldatum:</strong> <span id="printDate"></span></p>
                </div>
                <table id="printOrderTable"></table>
            </div>
            
            
        </div>
    </div>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbzheLy6YZNKjsWvWa_wcLqZ_tkDDoHhUalTQtEES8wGUtAS6-j0ThX8ZI1qAQ4jqEgjMw/exec';
        
        let products = [];
        let allColors = [];
        let schuelerData = {};
        let einstellungen = {};
        
        const colorMap = {
            'wei√ü': 'white',
            'rot': 'red',
            'royalblau': 'royalblue',
            'dunkelblau': 'darkblue',
            'schwarz': 'black',
            'orange': 'orange',
            'lila': 'purple',
            'azurblau': 'deepskyblue',
            'fuchsia': 'fuchsia',
            'gr√ºn': 'green',
            'burgund': '#800020',
            'hellgrau': 'lightgray',
            'dunkelgrau': 'darkgray'
        };

        async function loadArtikel() {
            try {
                // Lade Einstellungen
                const einstellungenResponse = await fetch(scriptURL + '?action=getEinstellungen');
                const einstellungenText = await einstellungenResponse.text();
                einstellungen = JSON.parse(einstellungenText);
                
                // Pr√ºfe ob Bestellungen ge√∂ffnet sind
                if (!checkIfOpen()) {
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('closedMessage').classList.add('show');
                    return;
                }
                
                // Aktualisiere Header und Deadline mit den geladenen Daten
                updateHeaderAndDeadline();
                
                // Lade Artikel
                const artikelResponse = await fetch(scriptURL + '?action=getArtikel');
                const artikelText = await artikelResponse.text();
                const artikelData = JSON.parse(artikelText);
                
                if (!artikelData || artikelData.length === 0) {
                    throw new Error('Keine Artikel gefunden');
                }
                
                products = artikelData;
                
                const colorSet = new Set();
                products.forEach(p => p.colors.forEach(c => colorSet.add(c)));
                allColors = Array.from(colorSet);
                
                // Lade Sch√ºler
                const schuelerResponse = await fetch(scriptURL + '?action=getSchueler');
                const schuelerText = await schuelerResponse.text();
                schuelerData = JSON.parse(schuelerText);
                
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('orderForm').style.display = 'block';
                
                initializeKlassenDropdown();
                initializeColorLegend();
                initializeTable();
                
            } catch (error) {
                console.error('Fehler beim Laden:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
            }
        }
        
        function checkIfOpen() {
            if (!einstellungen.bestellungOffen) {
                return false;
            }
            
            const now = new Date();
            
            // Wenn Start-Datum gesetzt ist, pr√ºfe ob wir schon im Zeitraum sind
            if (einstellungen.startDatum) {
                const startDate = new Date(einstellungen.startDatum);
                if (now < startDate) {
                    const startFormatted = formatDate(einstellungen.startDatum);
                    document.getElementById('closedMessageText').innerHTML = 
                        `Das Bestellformular ist ab dem <strong>${startFormatted}</strong> verf√ºgbar.<br>Bitte versuchen Sie es zu diesem Zeitpunkt erneut.`;
                    return false;
                }
            }
            
            // Wenn End-Datum gesetzt ist, pr√ºfe ob wir noch im Zeitraum sind
            if (einstellungen.endDatum) {
                const endDate = new Date(einstellungen.endDatum);
                if (now > endDate) {
                    document.getElementById('closedMessageText').innerHTML = 
                        `Der Bestellzeitraum ist abgelaufen.<br>Bestellungen waren bis zum <strong>${formatDate(einstellungen.endDatum)}</strong> m√∂glich.`;
                    return false;
                }
            }
            
            return true;
        }
        
        function formatDate(dateString) {
            // Konvertiere das Datum von ISO-Format in DD.MM.YYYY
            const date = new Date(dateString);
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            return `${day}.${month}.${year}`;
        }
        
        function updateHeaderAndDeadline() {
            // Aktualisiere Schuljahr im Header
            if (einstellungen.schuljahr) {
                document.getElementById('schuljahrDisplay').textContent = 'Schuljahr ' + einstellungen.schuljahr;
            }
            
            // Aktualisiere Abgabetermin
            if (einstellungen.abgabetermin) {
                const deadline = formatDate(einstellungen.abgabetermin);
                document.getElementById('deadlineDisplay').innerHTML = 
                    `‚ö†Ô∏è Letzter Abgabetermin: ${deadline} - Sp√§tere Abgabe kann bei Bestellung nicht ber√ºcksichtigt werden! Bestellung verpflichtet zum Kauf!`;
                
                // Aktualisiere auch in der Erfolgs-Nachricht
                document.getElementById('deadlineInSuccess').textContent = deadline;
                
                // Aktualisiere in der Unterschriften-Sektion
                document.getElementById('signatureWarning').innerHTML = 
                    `Diese Bestellung ist nur g√ºltig, wenn sie ausgedruckt, unterschrieben und bis sp√§testens ${deadline} im Sekretariat abgegeben wird!`;
            }
        }
        
        function initializeKlassenDropdown() {
            const klassenSelect = document.getElementById('studentClass');
            klassenSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
            
            const klassen = Object.keys(schuelerData).sort();
            klassen.forEach(klasse => {
                const option = document.createElement('option');
                option.value = klasse;
                option.textContent = klasse;
                klassenSelect.appendChild(option);
            });
        }
        
        function updateSchuelerDropdown() {
            const klassenSelect = document.getElementById('studentClass');
            const schuelerSelect = document.getElementById('studentName');
            const selectedKlasse = klassenSelect.value;
            
            schuelerSelect.innerHTML = '<option value="">Bitte w√§hlen...</option>';
            
            if (selectedKlasse && schuelerData[selectedKlasse]) {
                const schueler = schuelerData[selectedKlasse];
                schueler.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    schuelerSelect.appendChild(option);
                });
            }
        }
        
        function initializeColorLegend() {
            const legend = document.getElementById('colorLegend');
            legend.innerHTML = '';
            
            allColors.forEach(color => {
                const colorBox = document.createElement('div');
                colorBox.className = 'color-box';
                
                const colorSample = document.createElement('div');
                colorSample.className = 'color-sample';
                colorSample.style.background = colorMap[color] || color;
                if (color === 'wei√ü') {
                    colorSample.style.borderColor = '#000';
                }
                
                const colorLabel = document.createElement('span');
                colorLabel.textContent = color.charAt(0).toUpperCase() + color.slice(1);
                
                colorBox.appendChild(colorSample);
                colorBox.appendChild(colorLabel);
                legend.appendChild(colorBox);
            });
        }

        function initializeTable() {
            const container = document.getElementById('productsContainer');
            container.innerHTML = '';
            
            products.forEach((product, index) => {
                const card = document.createElement('div');
                card.className = 'product-card';
                card.id = 'product_' + index;
                
                let cardHTML = '<div class="product-header" onclick="toggleProduct(' + index + ')">';
                cardHTML += '<div class="product-header-item">';
                cardHTML += '<label>Artikel</label>';
                cardHTML += '<div class="value">' + product.name + '</div>';
                cardHTML += '</div>';
                
                cardHTML += '<div class="product-header-item">';
                cardHTML += '<label>Preis/St√ºck</label>';
                cardHTML += '<div class="value">' + product.price.toFixed(2) + ' ‚Ç¨</div>';
                cardHTML += '</div>';
                
                cardHTML += '<div class="product-header-item">';
                cardHTML += '<label>Gesamt</label>';
                cardHTML += '<div class="value" id="lineTotal_' + index + '">0,00 ‚Ç¨</div>';
                cardHTML += '</div>';
                
                cardHTML += '<div class="product-header-item">';
                cardHTML += '<label>Bestellt</label>';
                cardHTML += '<div class="value" id="itemCount_' + index + '">0 St√ºck</div>';
                cardHTML += '</div>';
                
                cardHTML += '<div class="expand-icon">+</div>';
                cardHTML += '</div>';
                
                cardHTML += '<div class="colors-grid">';
                
                allColors.forEach(color => {
                    const isAvailable = product.colors.includes(color);
                    cardHTML += '<div class="color-item' + (isAvailable ? '' : ' disabled') + '">';
                    cardHTML += '<div class="color-label">';
                    cardHTML += '<div class="color-sample" style="background: ' + (colorMap[color] || color) + '; ';
                    if (color === 'wei√ü') cardHTML += 'border-color: #000;';
                    cardHTML += '"></div>';
                    cardHTML += '<span>' + color.charAt(0).toUpperCase() + color.slice(1) + '</span>';
                    cardHTML += '</div>';
                    
                    // Gr√∂√üen-Eingabefelder
                    cardHTML += '<div class="size-inputs">';
                    product.sizes.forEach(size => {
                        cardHTML += '<div class="size-input-group">';
                        cardHTML += '<label>' + size + '</label>';
                        cardHTML += '<input type="number" min="0" max="99" value="0" ';
                        cardHTML += 'id="qty_' + index + '_' + color + '_' + size + '" ';
                        cardHTML += (isAvailable ? '' : 'disabled ');
                        cardHTML += 'onchange="calculateTotal()" ';
                        cardHTML += 'placeholder="0">';
                        cardHTML += '</div>';
                    });
                    cardHTML += '</div>';
                    
                    cardHTML += '</div>';
                });
                
                cardHTML += '</div>';
                
                card.innerHTML = cardHTML;
                container.appendChild(card);
            });
        }

        function toggleProduct(index) {
            const card = document.getElementById('product_' + index);
            card.classList.toggle('expanded');
        }

        function calculateTotal() {
            let grandTotal = 0;
            
            products.forEach((product, index) => {
                let lineTotal = 0;
                let itemCount = 0;
                
                allColors.forEach(color => {
                    product.sizes.forEach(size => {
                        const input = document.getElementById(`qty_${index}_${color}_${size}`);
                        if (input && !input.disabled) {
                            const qty = parseInt(input.value) || 0;
                            lineTotal += qty * product.price;
                            itemCount += qty;
                        }
                    });
                });
                
                document.getElementById(`lineTotal_${index}`).textContent = lineTotal.toFixed(2) + ' ‚Ç¨';
                document.getElementById(`itemCount_${index}`).textContent = itemCount + ' St√ºck';
                
                // Hervorhebung wenn Artikel bestellt wurden
                const countElement = document.getElementById(`itemCount_${index}`);
                if (itemCount > 0) {
                    countElement.style.color = '#38a169';
                    countElement.style.fontWeight = 'bold';
                } else {
                    countElement.style.color = '#667eea';
                    countElement.style.fontWeight = 'bold';
                }
                
                grandTotal += lineTotal;
            });
            
            document.getElementById('totalAmount').textContent = grandTotal.toFixed(2) + ' ‚Ç¨';
        }

        function resetForm() {
            if (confirm('M√∂chten Sie das Formular wirklich zur√ºcksetzen?')) {
                document.getElementById('orderForm').reset();
                initializeTable();
                calculateTotal();
            }
        }

        document.getElementById('orderForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const studentName = document.getElementById('studentName').value;
            const studentClass = document.getElementById('studentClass').value;
            const email = document.getElementById('email').value;
            const emailConfirm = document.getElementById('emailConfirm').value;
            
            // √úberpr√ºfe, ob beide E-Mail-Adressen √ºbereinstimmen
            if (email !== emailConfirm) {
                document.getElementById('emailMatchError').style.display = 'block';
                document.getElementById('emailConfirm').focus();
                alert('‚ö†Ô∏è Die E-Mail-Adressen stimmen nicht √ºberein!\n\nBitte √ºberpr√ºfen Sie Ihre Eingabe.');
                return;
            }
            
            // Verstecke Fehlermeldung, falls sie angezeigt war
            document.getElementById('emailMatchError').style.display = 'none';
            
            const orderItems = [];
            
            products.forEach((product, index) => {
                allColors.forEach(color => {
                    product.sizes.forEach(size => {
                       const qtyInput = document.getElementById(`qty_${index}_${color}_${size}`);
                        
                        if (qtyInput && !qtyInput.disabled) {
                            const qty = parseInt(qtyInput.value) || 0;
                            
                            if (qty > 0) {
                                orderItems.push({
                                    artikelnummer: product.artikelnummer,
                                    name: product['Artikel-Name'] || product.name || 'Artikel',
                                    gr√∂√üe: size,
                                    farbe: color,
                                    anzahl: qty,
                                    preis: product.price,
                                    gesamt: qty * product.price
                                });
                            }
                        }
                    });
                });
            });
            
            if (orderItems.length === 0) {
                alert('Bitte w√§hlen Sie mindestens einen Artikel aus!\n\nTragen Sie bei der gew√ºnschten Farbe und Gr√∂√üe die Anzahl ein.');
                return;
            }
            
            const totalAmount = orderItems.reduce((sum, item) => sum + item.gesamt, 0);
            
            const orderData = {
                timestamp: new Date().toISOString(),
                name: studentName,
                klasse: studentClass,
                email: email,
                bestellungen: orderItems,
                gesamtbetrag: totalAmount
            };
            
            console.log('Bestellung:', orderData);
            
            const submitBtn = document.querySelector('.btn-primary');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Wird gesendet...';
            
            const params = new URLSearchParams();
            params.append('name', orderData.name);
            params.append('klasse', orderData.klasse);
            params.append('email', orderData.email);
            params.append('gesamtbetrag', orderData.gesamtbetrag);
            params.append('bestellungen', JSON.stringify(orderData.bestellungen));
            params.append('timestamp', orderData.timestamp);
            
            const fullURL = scriptURL + '?' + params.toString();
            
            const img = document.createElement('img');
            img.style.display = 'none';
            img.src = fullURL;
            img.onerror = function() {
                setTimeout(() => {
                    preparePrintSummary(orderData, orderItems);
                    document.getElementById('successMessage').classList.add('show');
                    alert('‚úÖ Bestellung erfolgreich √ºbermittelt!\n\nSie erhalten gleich eine E-Mail.\n\nKlicken Sie auf den Druck-Button oder dr√ºcken Sie Strg+P zum Ausdrucken.');
                    window.scrollTo(0, 0);
                    
                    // Formular zur√ºcksetzen nach erfolgreicher Bestellung
                    document.getElementById('orderForm').reset();
                    document.getElementById('studentClass').selectedIndex = 0;
                    document.getElementById('studentName').innerHTML = '<option value="">Erst Klasse w√§hlen...</option>';
                    initializeTable();
                    calculateTotal();
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Bestellung absenden';
                    document.body.removeChild(img);
                }, 500);
            };
            img.onload = function() {
                setTimeout(() => {
                    preparePrintSummary(orderData, orderItems);
                    document.getElementById('successMessage').classList.add('show');
                    alert('‚úÖ Bestellung erfolgreich √ºbermittelt!\n\nSie erhalten gleich eine E-Mail.\n\nKlicken Sie auf den Druck-Button oder dr√ºcken Sie Strg+P zum Ausdrucken.');
                    window.scrollTo(0, 0);
                    
                    // Formular zur√ºcksetzen nach erfolgreicher Bestellung
                    document.getElementById('orderForm').reset();
                    document.getElementById('studentClass').selectedIndex = 0;
                    document.getElementById('studentName').innerHTML = '<option value="">Erst Klasse w√§hlen...</option>';
                    initializeTable();
                    calculateTotal();
                    
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Bestellung absenden';
                    document.body.removeChild(img);
                }, 500);
            };
            document.body.appendChild(img);
        });
        
        function preparePrintSummary(orderData, orderItems) {
            // KRITISCH: Zeige die Druck-Sektion nur nach erfolgreicher Bestellung an
            document.getElementById('printSummary').style.display = 'block';
            document.getElementById('signatureSection').style.display = 'block';
            
            // F√ºlle die Kundeninfos
            document.getElementById('printName').textContent = orderData.name;
            document.getElementById('printClass').textContent = orderData.klasse;
            document.getElementById('printEmail').textContent = orderData.email;
            
            // Formatiere das Datum sch√∂n
            const now = new Date();
            const dateString = now.toLocaleDateString('de-DE', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            }) + ' um ' + now.toLocaleTimeString('de-DE', {
                hour: '2-digit',
                minute: '2-digit'
            }) + ' Uhr';
            document.getElementById('printDate').textContent = dateString;
            
            // Erstelle die Tabelle mit bestellten Artikeln
            let tableHTML = '<thead><tr>';
            tableHTML += '<th>Artikel</th>';
            tableHTML += '<th>Gr√∂√üe</th>';
            tableHTML += '<th>Farbe</th>';
            tableHTML += '<th>Anzahl</th>';
            tableHTML += '<th>Einzelpreis</th>';
            tableHTML += '<th>Gesamtpreis</th>';
            tableHTML += '</tr></thead><tbody>';
            
            orderItems.forEach(item => {
                tableHTML += '<tr>';
                tableHTML += '<td>' + (item['Artikel-Name'] || item.name || 'Artikel') + '</td>';
                tableHTML += '<td>' + item.gr√∂√üe + '</td>';
                tableHTML += '<td>' + item.farbe + '</td>';
                tableHTML += '<td>' + item.anzahl + '</td>';
                tableHTML += '<td>' + item.preis.toFixed(2) + ' ‚Ç¨</td>';
                tableHTML += '<td><strong>' + item.gesamt.toFixed(2) + ' ‚Ç¨</strong></td>';
                tableHTML += '</tr>';
            });
            
            tableHTML += '<tr class="total-row">';
            tableHTML += '<td colspan="5" style="text-align: right;">GESAMTBETRAG:</td>';
            tableHTML += '<td style="color: #667eea; font-size: 18px;"><strong>' + orderData.gesamtbetrag.toFixed(2) + ' ‚Ç¨</strong></td>';
            tableHTML += '</tr></tbody>';
            
            document.getElementById('printOrderTable').innerHTML = tableHTML;
        }

        // Echtzeit-√úberpr√ºfung der E-Mail-Felder
        document.getElementById('emailConfirm').addEventListener('input', function() {
            const email = document.getElementById('email').value;
            const emailConfirm = this.value;
            const errorMsg = document.getElementById('emailMatchError');
            
            if (emailConfirm.length > 0 && email !== emailConfirm) {
                errorMsg.style.display = 'block';
            } else {
                errorMsg.style.display = 'none';
            }
        });

        loadArtikel();
    </script>
</body>
</html>
